<!DOCTYPE html>
<html>
<head>
  <title>IRC Chat Client</title>
  <style>
    body { font-family: sans-serif; background: #121212; color: #e0e0e0; margin: 20px; }
    input, textarea { background: #1e1e2e; color: white; border: 1px solid #444; border-radius: 6px; padding: 8px; }
    textarea { width: 100%; box-sizing: border-box; margin-bottom: 10px; }
    input { width: calc(100% - 120px); margin-right: 10px; }
    .btn { padding: 8px 12px; margin: 4px 4px 4px 0; background: #33334d; color: white; border: none; border-radius: 6px; cursor: pointer; }
    .btn:hover { background: #4a4a6f; }
    .avatar-img { width: 24px; height: 24px; vertical-align: middle; border-radius: 50%; margin-right: 6px; }
  </style>
</head>
<body>
  <h1>IRC Client</h1>
  <h3>Paste Server Answer</h3>
  <textarea id="answerInput" rows="6" placeholder="Paste server answer here"></textarea><br>
  <button class="btn" onclick="connectToServer()">Connect to Server</button>

  <h3>Send This Offer to Server</h3>
  <textarea id="offerOutput" rows="6" readonly></textarea>

  <h3>Chat Log</h3>
  <textarea id="log" rows="15" readonly></textarea><br>
  <input id="messageInput" placeholder="Your message...">
  <button class="btn" onclick="sendMessage()">Send</button>

  <script>
    let pc;
    let dc;
    const logBox = document.getElementById("log");
    const chatHistory = [];

    const emojiMap = { smile: "😄", fire: "🔥", wave: "👋", heart: "❤️", thumbsup: "👍" };

    function log(msg) {
      logBox.value += msg + "\n";
      logBox.scrollTop = logBox.scrollHeight;
      chatHistory.push(msg);
    }

    function createPeerConnection() {
      pc = new RTCPeerConnection({ iceServers: [{ urls: "stun:stun.l.google.com:19302" }] });
      const candidates = [];

      dc = pc.createDataChannel("chat");
      dc.onopen = () => log("[Client] Connected to server.");
      dc.onmessage = e => {
        log(e.data);
        new Audio("https://www.soundjay.com/buttons/sounds/button-3.mp3").play();
      };

      pc.onicecandidate = e => {
        if (e.candidate) {
          candidates.push(e.candidate);
        } else {
          document.getElementById("offerOutput").value = JSON.stringify({ offer: pc.localDescription, ice: candidates }, null, 2);
        }
      };

      return pc;
    }

    async function connectToServer() {
      const answerText = document.getElementById("answerInput").value;
      let parsed;
      try {
        parsed = JSON.parse(answerText);
      } catch (err) {
        log("[Error] Invalid JSON in answer.");
        return;
      }

      try {
        await pc.setRemoteDescription(new RTCSessionDescription(parsed.answer));
        for (const c of parsed.ice) {
          await pc.addIceCandidate(new RTCIceCandidate(c));
        }
      } catch (err) {
        log("[Error] " + err.message);
      }
    }

    async function start() {
      createPeerConnection();
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
    }

    function sendMessage() {
      const msg = document.getElementById("messageInput").value;
      const emojiText = msg.replace(/:(\w+):/g, (m, p1) => emojiMap[p1] || m);
      if (dc.readyState === "open") {
        dc.send(emojiText);
        log("Me: " + emojiText);
        document.getElementById("messageInput").value = "";
      } else {
        log("[Error] Connection not open.");
      }
    }

    window.onload = () => {
      start();
    };
  </script>
</body>
</html>
